<!DOCTYPE html>
<html lang="it" class="dark">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta name="theme-color" content="#0f172a">
    <title>Storico Notifiche</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0a0f1e;
            color: #f8fafc;
            overflow-x: hidden;
        }

        .filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* 3) FARO ANIMATO (GLASS GLOW) */
        @keyframes glowFloat {

            0%,
            100% {
                opacity: 0.6;
                transform: translateY(0) scale(1);
            }

            50% {
                opacity: 0.9;
                transform: translateY(-10px) scale(1.05);
            }
        }

        .glass-glow {
            position: absolute;
            top: 0;
            left: 50%;
            width: 150%;
            height: 120%;
            background: radial-gradient(ellipse at 50% 0%,
                    rgba(80, 150, 255, 0.4) 0%,
                    rgba(80, 150, 255, 0.15) 25%,
                    rgba(80, 150, 255, 0.05) 50%,
                    transparent 75%);
            filter: blur(80px);
            z-index: 0;
            pointer-events: none;
            transform: translateX(-50%);
            animation: glowFloat 4s ease-in-out infinite;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* 9) BORDER GLOW */
        .border-glow {
            position: relative;
        }

        .border-glow::after {
            content: "";
            position: absolute;
            inset: 0;
            padding: 1px;
            border-radius: inherit;
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.2), transparent, rgba(255, 255, 255, 0.05));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-[#0a0f1e] text-slate-50 antialiased selection:bg-blue-500/30">
    <!-- 2) Contenitore Principale -->
    <div
        class="relative flex min-h-screen w-full flex-col md:max-w-3xl lg:max-w-5xl mx-auto shadow-2xl overflow-hidden bg-gradient-to-l from-[#030712] to-[#162e6e]">

        <!-- 3) Faro -->
        <div class="glass-glow"></div>

        <!-- 4) Header Fusion -->
        <header
            class="fixed top-0 left-0 right-0 mx-auto w-full md:max-w-3xl lg:max-w-5xl z-50 bg-gradient-to-b from-[#0a0f1e] to-transparent backdrop-blur-md">
            <div class="flex items-center justify-between px-4 h-16">
                <div class="flex items-center gap-3">
                    <a href="impostazioni.html"
                        class="p-2 -ml-2 rounded-xl hover:bg-white/5 text-gray-400 hover:text-white transition-colors relative z-10">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </a>
                    <h1 class="text-lg font-bold text-white tracking-tight relative z-10">Storico Notifiche</h1>
                </div>
                <button onclick="clearHistory()"
                    class="p-2 hover:bg-white/5 rounded-xl text-red-400 hover:text-red-300 transition-colors relative z-10"
                    title="Azzera Storico">
                    <span class="material-symbols-outlined text-[20px]">delete_sweep</span>
                </button>
            </div>
        </header>

        <!-- Spacer -->
        <div class="h-16 w-full shrink-0"></div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar pb-24 relative z-10">
            <div class="px-4 py-6">
                <!-- Loading State -->
                <div id="loading-indicator" class="flex flex-col items-center justify-center py-20">
                    <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-gray-500 text-xs font-medium mt-3 uppercase tracking-wider">Caricamento...</p>
                </div>

                <!-- List Container -->
                <div id="notifications-list" class="space-y-3">
                    <!-- Notifications will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center">
                    <div
                        class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mb-4 border border-white/5">
                        <span class="material-symbols-outlined text-3xl text-gray-600">notifications_off</span>
                    </div>
                    <h3 class="text-white text-base font-bold">Nessuna notifica</h3>
                    <p class="text-gray-500 text-sm mt-1 max-w-[200px]">Non hai ancora ricevuto notifiche recenti.</p>
                </div>
            </div>
        </main>

        <!-- 5) Footer Fusion -->
        <footer
            class="fixed bottom-0 left-0 right-0 mx-auto w-full md:max-w-3xl lg:max-w-5xl h-20 bg-gradient-to-t from-[#0a0f1e] to-transparent backdrop-blur-sm pointer-events-none z-40">
        </footer>
    </div>

    <!-- Scripts (Firebase Compat) -->
    <!-- Note: Keeping original Firebase Compat imports as in previous file, assuming global firebase object -->
    <!-- Adjust paths if necessary based on project structure. Using same logic as view_file which seemed to rely on existing firebase global? 
         Wait, the previous file didn't import firebase scripts explicitly in the head, likely relying on a layout or implicit load? 
         I will add them to be safe if they are not present, but usually they are. 
         Actually, let's look at index.html or other files. Using the standard Modular logic in other files, but this one used 'const db = firebase.firestore()'.
         I will keep it compatible or switch to modular if I can easily. 
         Since I want to be safe, I will stick to what was there, but assume the scripts are loaded. 
         Wait, line 82: "const db = firebase.firestore();" implies firebase is global.
         I will add the CDN links just in case, referencing 8.x or similar compat usually used in these legacy-style files.
         Or better, I'll switch to the Modular imports I used in dati_azienda.js?
         User's prompt said "Verify JavaScript compatibility".
         I should align with `dati_azienda.js` imports: `import { auth, db } from './assets/js/firebase-config.js';`
         This is much cleaner and consistent.
    -->
    <script type="module">
        import { auth, db } from './assets/js/firebase-config.js';
        import { collection, doc, getDocs, deleteDoc, writeBatch, orderBy, query, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Expose functions to window
        window.clearHistory = clearHistory;

        onAuthStateChanged(auth, user => {
            if (user) {
                loadNotifications(user.uid);
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadNotifications(uid) {
            const listContainer = document.getElementById('notifications-list');
            const loadingIndicator = document.getElementById('loading-indicator');
            const emptyState = document.getElementById('empty-state');

            try {
                // Query notifications subcollection order by timestamp desc
                const q = query(
                    collection(db, 'users', uid, 'notifications'),
                    orderBy('timestamp', 'desc'),
                    limit(50)
                );

                const snapshot = await getDocs(q);

                loadingIndicator.classList.add('hidden');

                if (snapshot.empty) {
                    emptyState.classList.remove('hidden');
                    return;
                }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const date = data.timestamp ? new Date(data.timestamp.toDate()) : new Date();
                    const formattedDate = date.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

                    let icon = 'notifications';
                    let iconBg = 'bg-blue-500/10 text-blue-500 border-blue-500/20';

                    // Customize icon based on type
                    if (data.type === 'invite_accepted') {
                        icon = 'check_circle';
                        iconBg = 'bg-green-500/10 text-green-500 border-green-500/20';
                    } else if (data.type === 'invite_rejected' || data.type === 'share_revoked') {
                        icon = 'cancel';
                        iconBg = 'bg-red-500/10 text-red-500 border-red-500/20';
                    } else if (data.type === 'deadline') {
                        icon = 'warning';
                        iconBg = 'bg-amber-500/10 text-amber-500 border-amber-500/20';
                    }

                    const item = document.createElement('div');
                    item.className = 'group bg-[#1e293b] p-4 rounded-xl border border-white/5 shadow-lg flex items-start gap-4 transition-all hover:bg-[#1e293b]/80';

                    item.innerHTML = `
                        <div class="shrink-0 h-10 w-10 flex items-center justify-center rounded-lg border ${iconBg}">
                            <span class="material-symbols-outlined text-[20px] filled">${icon}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-white leading-snug">${data.message || 'Notifica'}</p>
                            <p class="text-xs text-gray-500 mt-1 font-mono">${formattedDate}</p>
                        </div>
                    `;

                    listContainer.appendChild(item);
                });

            } catch (error) {
                console.error("Error loading notifications:", error);
                loadingIndicator.classList.add('hidden');
            }
        }

        async function clearHistory() {
            const user = auth.currentUser;
            if (!user) return;

            if (!confirm('Sei sicuro di voler cancellare tutto lo storico notifiche?')) return;

            const listContainer = document.getElementById('notifications-list');
            const emptyState = document.getElementById('empty-state');
            const loadingIndicator = document.getElementById('loading-indicator');

            try {
                loadingIndicator.classList.remove('hidden');
                listContainer.classList.add('hidden');

                // Get all docs
                const q = collection(db, 'users', user.uid, 'notifications');
                const snapshot = await getDocs(q);

                // Batch delete
                const batch = writeBatch(db);
                snapshot.docs.forEach(docSnap => {
                    batch.delete(docSnap.ref);
                });

                await batch.commit();

                // Update UI
                listContainer.innerHTML = '';
                listContainer.classList.remove('hidden');
                emptyState.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');

            } catch (error) {
                console.error("Error clearing history:", error);
                alert("Errore durante la cancellazione dello storico.");
                loadingIndicator.classList.add('hidden');
                listContainer.classList.remove('hidden');
            }
        }
    </script>
</body>

</html>