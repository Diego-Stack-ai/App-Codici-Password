<!DOCTYPE html>
<html class="dark" lang="it">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta name="color-scheme" content="dark only">
    <meta name="theme-color" content="#0a0f1e">
    <title>Home Page</title>
    <!-- PWA / Mobile Capable -->
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" sizes="192x192" href="/assets/images/app-icon.png?v=2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="App Codici">
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&amp;display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        /* Fonte Unica di Verità - DARK PAGE */
        body {
            min-height: 100dvh;
            background-color: #0a0f1e;
            color: #ffffff;
        }

        /* Dynamic Name Link Styling */
        #user-name a {
            color: inherit;
            text-decoration: none;
        }

        #user-name a:hover {
            text-decoration: underline;
        }

        .filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* PUNTO LUCE A FARO (BEACON EFFECT) */
        .glass-glow {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150%;
            height: 120%;
            background: radial-gradient(ellipse at 50% 0%,
                    rgba(80, 150, 255, 0.6) 0%,
                    rgba(80, 150, 255, 0.2) 25%,
                    rgba(80, 150, 255, 0.05) 50%,
                    transparent 75%);
            filter: blur(80px);
            opacity: 1;
            pointer-events: none;
            z-index: 0;
            animation: glowFloat 5s ease-in-out infinite;
        }

        @keyframes glowFloat {
            0% {
                transform: translateX(-50%) translateY(-150px) scale(1);
                opacity: 0.5;
            }

            50% {
                transform: translateX(-50%) translateY(100px) scale(1.4);
                opacity: 1;
            }

            100% {
                transform: translateX(-50%) translateY(-150px) scale(1);
                opacity: 0.5;
            }
        }

        /* BORDO RIFLETTENTE (GLOW BORDER) */
        .border-glow {
            position: relative;
        }

        .border-glow::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 1.5px;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.6) 0%, rgba(255, 255, 255, 0.1) 40%, rgba(255, 255, 255, 0.1) 60%, rgba(255, 255, 255, 0.6) 100%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            pointer-events: none;
            z-index: 20;
        }

        /* SAETTA ANIMATA (GOLD SHIMMER) */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .saetta-gold {
            position: absolute;
            inset: 0;
            background: linear-gradient(110deg, transparent 42%, rgba(255, 255, 255, 0.1) 50%, transparent 58%);
            background-size: 200% 100%;
            animation: shimmer 4s infinite linear;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>

<body class="font-display overflow-x-hidden antialiased bg-[#0a0f1e] text-white">
    <div
        class="relative flex h-full min-h-screen w-full flex-col w-full md:max-w-3xl lg:max-w-5xl mx-auto shadow-2xl overflow-hidden bg-gradient-to-l from-[#030712] to-[#162e6e]">

        <!-- GLOW LAYER (Animated Beacon) -->
        <div class="glass-glow" style="animation-duration: 4s;"></div>

        <!-- TopAppBar (Fixed Glass Sfumato) -->
        <div
            class="fixed top-0 left-0 right-0 mx-auto w-full md:max-w-3xl lg:max-w-5xl flex items-center justify-between p-4 z-50 backdrop-blur-md bg-gradient-to-b from-[#0a0f1e] to-transparent select-none">
            <div class="flex size-12 shrink-0 items-center">
                <div id="user-avatar"
                    class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-primary/20 shadow-lg"
                    data-alt="User Avatar" style='background-image: url("assets/images/user-avatar-4.png");'></div>
            </div>
            <div class="flex flex-1 flex-col px-4">
                <p id="greeting-text" class="text-blue-100/40 text-xs font-medium leading-normal">Buon pomeriggio,</p>
                <h2 id="user-name"
                    class="text-lg font-bold leading-tight tracking-tight transition-colors duration-300 text-white">
                    ...</h2>
            </div>
            <div class="flex w-12 items-center justify-end">
                <button id="logout-button"
                    class="flex items-center justify-center rounded-full size-10 bg-white/5 text-white hover:bg-white/10 transition-colors border-glow"
                    title="Logout">
                    <span class="material-symbols-outlined text-[22px]">logout</span>
                </button>
            </div>
        </div>

        <!-- Header Spacer -->
        <div class="h-20 w-full shrink-0"></div>

        <script>
            (function () {
                const hour = new Date().getHours();
                const greetingEl = document.getElementById('greeting-text');
                let text = "Buon giorno,";
                if (hour >= 13 && hour < 17) text = "Buon pomeriggio,";
                else if (hour >= 17 || hour < 5) text = "Buona sera,";
                if (greetingEl) greetingEl.textContent = text;
            })();
        </script>
        <div id="notification-banner" class="hidden fixed top-4 right-4 p-4 rounded-lg text-white z-50"></div>

        <!-- Main Action Buttons -->
        <div class="px-4 pb-6 pt-2">

            <div class="grid grid-cols-2 gap-4">
                <!-- Privato -->
                <a href="area_privata.html"
                    class="group relative border-glow flex flex-col items-start justify-between p-4 rounded-[24px] bg-gradient-to-l from-[#1976D2] to-[#2196F3] text-white shadow-lg overflow-hidden hover:-translate-y-1 transition-all duration-300 border-0">



                    <!-- 2. SAETTA (Metallic Streak) -->
                    <div class="absolute inset-0 opacity-20 pointer-events-none z-0"
                        style="background: linear-gradient(110deg, transparent 42%, rgba(255,255,255,0.12) 50%, transparent 58%);">
                    </div>

                    <!-- 3. GLASS SHINE (Hover Effect) -->
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-[24px] pointer-events-none z-10">
                    </div>

                    <div
                        class="absolute right-[-10px] bottom-[-20px] opacity-10 group-hover:opacity-20 transition-transform duration-500 group-hover:scale-110 group-hover:rotate-12 pointer-events-none z-0">
                        <span class="material-symbols-outlined text-[100px] text-white">lock</span>
                    </div>

                    <div
                        class="flex flex-col items-start gap-1 z-10 mb-2 transform transition-transform group-hover:translate-x-1 select-none">
                        <h3 class="text-xl font-bold drop-shadow-md">Privato</h3>
                        <p class="text-blue-50 text-xs font-medium opacity-90">Cassaforte Personale</p>
                    </div>
                    <div
                        class="flex items-center justify-center w-10 h-10 rounded-full bg-white/20 backdrop-blur-md border border-white/40 z-10 self-end shadow-md group-hover:scale-110 transition-transform">
                        <span class="material-symbols-outlined text-[24px]">person</span>
                    </div>
                </a>

                <!-- Azienda -->
                <a href="lista_aziende.html"
                    class="group relative border-glow flex flex-col items-start justify-between p-4 rounded-[24px] bg-gradient-to-l from-[#2E7D32] to-[#00C853] text-white shadow-lg overflow-hidden hover:-translate-y-1 transition-all duration-300 border-0">



                    <!-- 2. SAETTA -->
                    <div class="absolute inset-0 opacity-20 pointer-events-none z-0"
                        style="background: linear-gradient(110deg, transparent 42%, rgba(255,255,255,0.12) 50%, transparent 58%);">
                    </div>

                    <!-- 3. GLASS SHINE -->
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-[24px] pointer-events-none z-10">
                    </div>

                    <div
                        class="absolute right-[-10px] bottom-[-20px] opacity-10 group-hover:opacity-20 transition-transform duration-500 group-hover:scale-110 group-hover:rotate-12 pointer-events-none z-0">
                        <span class="material-symbols-outlined text-[100px] text-white">apartment</span>
                    </div>

                    <div
                        class="flex flex-col items-start gap-1 z-10 mb-2 transform transition-transform group-hover:translate-x-1 select-none">
                        <h3 class="text-xl font-bold drop-shadow-md">Azienda</h3>
                        <p class="text-green-50 text-xs font-medium opacity-90">Gestione Risorse</p>
                    </div>
                    <div
                        class="flex items-center justify-center w-10 h-10 rounded-full bg-white/20 backdrop-blur-md border border-white/40 z-10 self-end shadow-md group-hover:scale-110 transition-transform">
                        <span class="material-symbols-outlined text-[24px]">domain</span>
                    </div>
                </a>

                <!-- Scadenze (Premium Metal Card) -->
                <a href="scadenze.html"
                    class="group col-span-2 w-full relative border-glow flex flex-col justify-between p-5 rounded-[24px] bg-gradient-to-l from-[#E65100] to-[#FF9800] text-white shadow-lg overflow-hidden hover:-translate-y-1 transition-all duration-300 min-h-[140px] border-0">



                    <!-- 2. SAETTA -->
                    <div class="absolute inset-0 opacity-20 pointer-events-none z-0"
                        style="background: linear-gradient(110deg, transparent 42%, rgba(255,255,255,0.12) 50%, transparent 58%);">
                    </div>

                    <!-- 3. GLASS SHINE -->
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-[24px] pointer-events-none z-10">
                    </div>

                    <div
                        class="absolute right-[-10px] bottom-[-20px] opacity-20 group-hover:opacity-30 transition-transform duration-500 group-hover:scale-110 group-hover:rotate-12 pointer-events-none z-0">
                        <span class="material-symbols-outlined text-[100px] text-white">calendar_month</span>
                    </div>

                    <div class="relative z-10 flex flex-col items-start gap-1 select-none">
                        <div class="flex items-center gap-2">
                            <h3 class="text-[26px] font-bold leading-tight tracking-tight drop-shadow-sm">Scadenze</h3>
                            <div id="urgent-count-badge"
                                class="px-2 py-0.5 rounded-full bg-white/20 backdrop-blur-md border border-white/30 shadow-lg opacity-30 transition-opacity duration-300">
                                <span id="urgent-count" class="text-white text-xs font-bold drop-shadow-sm">0</span>
                            </div>
                        </div>
                        <p class="text-orange-50 text-xs font-medium opacity-90">Controlla i prossimi impegni</p>
                    </div>

                    <div id="deadline-list-container"
                        class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-2 mt-3 max-h-[160px] overflow-y-auto no-scrollbar">
                    </div>

                    <div class="absolute bottom-4 right-4 z-10">
                        <div
                            class="flex items-center justify-center w-12 h-12 rounded-full bg-white/20 backdrop-blur-md border border-white/30 shadow-lg shadow-black/10 transition-transform group-hover:scale-110">
                            <span class="material-symbols-outlined text-[26px]">event_upcoming</span>
                        </div>
                    </div>
                </a>
            </div>

            <!-- Urgenze (Bottom Card) -->
            <div class="mt-4 mb-24 w-full">
                <div id="urgenze-card"
                    class="group relative border-glow rounded-[24px] p-5 border-0 shadow-lg overflow-hidden min-h-[140px] bg-gradient-to-l from-[#1e0707] to-[#450a0a] hover:-translate-y-1 transition-all duration-300">



                    <!-- 2. SAETTA -->
                    <div class="absolute inset-0 opacity-10 pointer-events-none z-0"
                        style="background: linear-gradient(110deg, transparent 42%, rgba(255,255,255,0.08) 50%, transparent 58%);">
                    </div>

                    <!-- 3. GLASS SHINE -->
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-[24px] pointer-events-none z-10">
                    </div>

                    <!-- Header inside card -->
                    <div
                        class="relative z-10 flex items-center justify-between border-b border-white/10 pb-3 mb-4 select-none">
                        <div class="flex flex-col">
                            <h3 class="text-[20px] font-bold text-white uppercase tracking-wide">Urgenze</h3>
                            <p class="text-red-200/40 text-[11px] font-medium">Pratiche scadute e da gestire</p>
                        </div>
                        <div
                            class="flex items-center justify-center w-8 h-8 rounded-full bg-white/5 border border-white/10">
                            <span class="material-symbols-outlined text-white/30 text-[18px]">update</span>
                        </div>
                    </div>

                    <div id="urgenze-list"
                        class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-2 max-h-[400px] overflow-y-auto no-scrollbar">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/js/main.js"></script>

    <!-- FIREBASE MODULAR SDK (Unified with Login/Register) -->
    <script type="module">
        import { auth, db } from './assets/js/firebase-config.js';
        import {
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import {
            collection,
            doc,
            getDoc,
            getDocs,
            query,
            where,
            updateDoc,
            arrayUnion,
            deleteDoc,
            addDoc
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        console.log("Home Page: Modalità Modulare");

        // --- DOM ELEMENTS ---
        // --- DOM ELEMENTS ---
        const avatarDiv = document.getElementById('user-avatar');
        const userNameEl = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-button');

        // --- CACHE RESTORE (Instant Load) ---
        function loadFromCache() {
            // FORCE CLEAR CACHE ONCE for debugging stale avatar
            // localStorage.removeItem('userProfileCache'); 

            const cached = localStorage.getItem('userProfileCache');
            if (cached) {
                try {
                    const data = JSON.parse(cached);
                    if (data.photoURL && avatarDiv) {
                        avatarDiv.style.backgroundImage = `url("${data.photoURL}")`;
                    }
                    if (data.displayName && userNameEl) {
                        userNameEl.innerHTML = `<a href="dati_anagrafici_privato.html">${data.displayName}</a>`;
                    }
                } catch (e) { console.error("Cache error", e); }
            }
        }

        loadFromCache();

        // --- LOGOUT LOGIC ---
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error("Logout error:", error);
                    alert("Errore durante il logout");
                }
            });
        }

        // --- AUTH & SYNC ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Utente connesso:", user.email);

                // FORCE RELOAD to get fresh token/profile
                try {
                    await user.reload();
                    console.log("Auth profile reloaded.");
                } catch (e) { console.warn("Relad failed", e); }

                // --- CHECK INVITES & SHARED & NOTIFICATIONS ---
                checkInvitations(user.email, user.uid);
                checkSharedAccounts(user.email);
                checkNotifications(user.uid);

                // 1. Basic Auth Info
                let displayName = user.displayName;
                let photoURL = user.photoURL;
                let cacheUpdate = {};

                if (photoURL && avatarDiv) {
                    avatarDiv.style.backgroundImage = `url("${photoURL}")`;
                    cacheUpdate.photoURL = photoURL;
                } else {
                    console.log("No Auth photoURL found.");
                }

                // 2. Fetch Firestore for Real Name
                try {
                    const docRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();

                        // Construct name from DB if available
                        if (data.nome || data.cognome) {
                            displayName = `${data.nome || ''} ${data.cognome || ''}`.trim();
                        }

                        // Fallback
                        if (!displayName) displayName = "Utente";

                        if (userNameEl) {
                            userNameEl.innerHTML = `<a href="dati_anagrafici_privato.html">${displayName}</a>`;
                        }

                        // Avatar fallback from Firestore
                        const firestorePhoto = data.photoURL || data.avatar;

                        if (firestorePhoto && avatarDiv) {
                            // Force update if Auth didn't have it or checks fail
                            avatarDiv.style.backgroundImage = `url("${firestorePhoto}")`;
                            cacheUpdate.photoURL = firestorePhoto;
                        }

                        // Update critical cache fields
                        cacheUpdate.displayName = displayName;
                        cacheUpdate.email = user.email;

                        // Get current cache to merge
                        const currentCache = JSON.parse(localStorage.getItem('userProfileCache') || '{}');
                        const newCache = { ...currentCache, ...cacheUpdate };
                        localStorage.setItem('userProfileCache', JSON.stringify(newCache));
                    } else {
                        // ZOMBIE USER DETECTED (Auth exists, Firestore Doc missing)
                        console.warn("Home: User authenticated but missing Firestore profile. Logging out.");
                        localStorage.removeItem('userProfileCache'); // Clear stale data
                        await signOut(auth);
                        alert("Profilo utente non trovato. Contatta l'assistenza.");
                        window.location.href = 'index.html';
                        return;
                    }
                } catch (e) {
                    console.error("Errore sync Firestore:", e);
                }

                // Load Deadlines
                loadUrgentDeadlinesCount(user);
                loadExpiredDeadlines(user);

            } else {
                console.log("Nessun utente. Redirect...");
                window.location.href = 'index.html';
            }
        });

        async function checkSharedAccounts(email) {
            const containerAccounts = document.getElementById('shared-container');
            const listAccounts = document.getElementById('shared-list');
            const containerMemos = document.getElementById('shared-memo-container');
            const listMemos = document.getElementById('shared-memo-list');

            if (!containerAccounts || !listAccounts) return;

            try {
                // Fetch accepted invites
                const q = query(
                    collection(db, "invites"),
                    where("recipientEmail", "==", email),
                    where("status", "==", "accepted")
                );
                const snap = await getDocs(q);

                // Reset views
                listAccounts.innerHTML = '';
                listMemos.innerHTML = '';
                containerAccounts.classList.add('hidden');
                if (containerMemos) containerMemos.classList.add('hidden');

                if (snap.empty) return;

                let hasAccounts = false;
                let hasMemos = false;

                // Fetch details for each accepted invite
                for (const docSnap of snap.docs) {
                    const inv = docSnap.data();
                    const inviteId = docSnap.id;
                    if (!inv.ownerId || !inv.accountId) continue;

                    try {
                        // Build correct reference based on account type
                        let accRef;
                        if (inv.aziendaId) {
                            // Company account
                            accRef = doc(db, "users", inv.ownerId, "aziende", inv.aziendaId, "accounts", inv.accountId);
                        } else {
                            // Private account
                            accRef = doc(db, "users", inv.ownerId, "accounts", inv.accountId);
                        }
                        const accSnap = await getDoc(accRef);

                        if (accSnap.exists()) {
                            const acc = accSnap.data();

                            // Determine Type: Default to 'account' if not specified
                            // Check 'type' field OR flags (hasMemo, isMemoShared)
                            const isMemo = acc.type === 'memorandum' || acc.category === 'memorandum' || !!acc.hasMemo || !!acc.isMemoShared;

                            const div = document.createElement('div');
                            // Style adjustment based on type
                            const borderColor = isMemo ? 'border-yellow-200' : 'border-indigo-200';
                            const hoverColor = isMemo ? 'hover:bg-yellow-50' : 'hover:bg-indigo-50';
                            const iconColor = isMemo ? 'text-yellow-400' : 'text-indigo-400';

                            div.className = `flex items-center justify-between bg-white  p-3 rounded-xl border ${borderColor} shadow-sm group transition-colors ${hoverColor}`;

                            div.innerHTML = `
                                <div class="flex items-center gap-3 flex-1 min-w-0 cursor-pointer" onclick="openSharedDetail('${inv.accountId}', '${inv.ownerId}', '${isMemo ? 'memorandum' : 'account'}')">
                                    <div class="flex flex-col gap-0.5 min-w-0">
                                        <p class="text-slate-900  text-sm font-bold truncate">
                                            ${acc.serviceName || acc.ragioneSociale || acc.title || (isMemo ? 'Nota Condivisa' : 'Account Condiviso')}
                                        </p>
                                        <p class="text-slate-500  text-[10px] truncate">
                                            <span class="${isMemo ? 'text-yellow-600' : 'text-indigo-500'} font-medium">Da:</span> ${inv.ownerEmail}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button onclick="removeSharedItem('${inviteId}', '${inv.ownerId}', '${inv.ownerEmail}')" class="p-2 text-gray-400 hover:text-red-500 transition-colors" title="Rimuovi condivisione">
                                        <span class="material-symbols-outlined text-[20px]">delete</span>
                                    </button>
                                    <span class="material-symbols-outlined ${iconColor}" onclick="openSharedDetail('${inv.accountId}', '${inv.ownerId}', '${isMemo ? 'memorandum' : 'account'}')">chevron_right</span>
                                </div>
                            `;

                            if (isMemo) {
                                hasMemos = true;
                                if (listMemos) listMemos.appendChild(div);
                            } else {
                                hasAccounts = true;
                                listAccounts.appendChild(div);
                            }
                        } else {
                            // Account logicamente rimosso dall'owner ma invito ancora valido?
                            console.warn("Account condiviso non trovato (forse eliminato dall'owner):", inv.accountId);
                        }
                    } catch (e) {
                        console.error("Error loading shared account details:", e);
                    }
                }

                if (hasAccounts) containerAccounts.classList.remove('hidden');
                if (hasMemos && containerMemos) containerMemos.classList.remove('hidden');

            } catch (e) {
                console.error("Errore account condivisi:", e);
            }
        }

        // Global function for navigation
        window.openSharedDetail = (accountId, ownerId, type) => {
            // Reindirizza alla pagina corretta passando l'ownerId
            // Se è memorandum, potrebbe servire una pagina diversa o la parametrizzazione
            // Per ora usiamo quella azienda/privato generica, ma idealmente avremmo dettaglio_memorandum.html
            // Se type è account, usiamo dettaglio_account_azienda.html (che è il più generico)

            let targetPage = 'dettaglio_account_azienda.html';
            // Se avessimo distinzione privato/azienda nel 'type' sarebbe meglio. 
            // Per ora assumiamo azienda come viewer standard.

            window.location.href = `${targetPage}?id=${accountId}&ownerId=${ownerId}&readonly=true&type=${type}`;
        };

        // Global function for removal (User 2 revokes access for themselves)
        window.removeSharedItem = async (inviteId, ownerId, ownerEmail) => {
            if (!confirm("Vuoi davvero rimuovere questo elemento dai tuoi condivisi?")) return;

            try {
                // 1. Delete the invite (User 2 side)
                await deleteDoc(doc(db, "invites", inviteId));

                // 2. Notify Owner (User 1)
                await addDoc(collection(db, "users", ownerId, "notifications"), {
                    type: "share_returned",
                    message: `Un utente ha rimosso la condivisione per un tuo elemento.`,
                    details: `L'utente ${auth.currentUser.email} ha rinunciato all'accesso.`,
                    timestamp: new Date(),
                    read: false,
                    // Additional info to help Owner identify which account
                    relatedEmail: auth.currentUser.email
                });

                alert("Elemento rimosso.");
                // Refresh lists
                checkSharedAccounts(auth.currentUser.email);
            } catch (e) {
                console.error("Errore rimozione condivisione:", e);
                alert("Errore durante la rimozione.");
            }
        };

        async function checkInvitations(email, uid) {
            const container = document.getElementById('invitations-container');
            const list = document.getElementById('invites-list');
            if (!container || !list) return;

            try {
                const q = query(
                    collection(db, "invites"),
                    where("recipientEmail", "==", email),
                    where("status", "==", "pending")
                );
                const snap = await getDocs(q);

                if (snap.empty) {
                    container.classList.add('hidden');
                    return;
                }

                container.classList.remove('hidden');
                list.innerHTML = '';

                snap.forEach(docSnap => {
                    const inv = docSnap.data();
                    const inviteId = docSnap.id;

                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between bg-white  p-3 rounded-xl border border-primary/10 shadow-sm min-w-0";
                    div.innerHTML = `
                        <div class="flex flex-col gap-0.5 min-w-0">
                            <p class="text-slate-900  text-sm font-bold truncate">${inv.accountName || 'Account Sconosciuto'}</p>
                            <p class="text-slate-500  text-[10px] truncate">Da: ${inv.ownerEmail}</p>
                        </div>
                        <div class="flex gap-2 shrink-0 ml-2">
                            <button onclick="window.handleInvite('${inviteId}', false)" class="px-2 py-1.5 rounded-lg bg-gray-100  text-[10px] font-bold text-gray-500">Rifiuta</button>
                            <button onclick="window.handleInvite('${inviteId}', true, '${uid}')" class="px-2 py-1.5 rounded-lg bg-primary text-white text-[10px] font-bold shadow-md shadow-primary/20">Accetta</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                console.error("Errore inviti:", e);
            }
        }

        // handleInvite is now defined later in the file with correct Rule 4 logic

        // Load urgent deadlines and render list
        async function loadUrgentDeadlinesCount(user) {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const snap = await getDocs(collection(db, "users", user.uid, "scadenze"));

                const urgentDeadlines = [];

                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const isCompleted = data.completed === true || data.status === 'completed';
                    if (isCompleted) return; // Salta se completato
                    if (data.dueDate) {
                        const dueDate = new Date(data.dueDate);
                        dueDate.setHours(0, 0, 0, 0);

                        // Use notificationDaysBefore field (default to 7 if not set)
                        const notifDays = data.notificationDaysBefore || 7;
                        const notifStartDate = new Date(dueDate);
                        notifStartDate.setDate(notifStartDate.getDate() - notifDays);

                        // Check if today is within the notification period
                        if (today >= notifStartDate && today <= dueDate) {
                            urgentDeadlines.push({
                                id: docSnap.id,
                                ...data,
                                dueDate: dueDate,
                                notifStartDate: notifStartDate
                            });
                        }
                    }
                });

                // Sort by due date (soonest first)
                urgentDeadlines.sort((a, b) => a.dueDate - b.dueDate);

                // Update badge
                const badge = document.getElementById('urgent-count-badge');
                const countSpan = document.getElementById('urgent-count');

                if (badge && countSpan) {
                    countSpan.textContent = urgentDeadlines.length;
                    if (urgentDeadlines.length > 0) {
                        badge.classList.remove('opacity-30');
                        badge.classList.add('opacity-100');
                    } else {
                        badge.classList.remove('opacity-100');
                        badge.classList.add('opacity-30');
                    }
                }

                // Render deadline list
                const listContainer = document.getElementById('deadline-list-container');
                if (listContainer) {
                    if (urgentDeadlines.length === 0) {
                        listContainer.innerHTML = '<p class="text-orange-100/60 text-xs italic">Nessuna scadenza imminente</p>';
                    } else {
                        listContainer.innerHTML = urgentDeadlines.map(deadline => {
                            const daysUntil = Math.ceil((deadline.dueDate - today) / (1000 * 60 * 60 * 24));
                            let badgeColor = 'bg-blue-500';
                            let badgeText = `${daysUntil}g`;

                            if (daysUntil < 0) {
                                badgeColor = 'bg-red-500';
                                badgeText = 'Scaduto';
                            } else if (daysUntil === 0) {
                                badgeColor = 'bg-red-500';
                                badgeText = 'Oggi';
                            } else if (daysUntil === 1) {
                                badgeColor = 'bg-orange-500';
                                badgeText = 'Domani';
                            } else if (daysUntil <= 3) {
                                badgeColor = 'bg-orange-500';
                            }

                            const icon = deadline.icon || 'event';
                            const title = deadline.title || 'Scadenza';

                            // Dynamic card color based on status
                            let cardGradient = 'linear-gradient(135deg, #FF9800 0%, #E65100 100%)'; // Default Orange
                            if (daysUntil < 0) {
                                cardGradient = 'linear-gradient(135deg, #6d1a1a 0%, #1a0505 100%)'; // Ruby Red
                            }

                            return `
                                    <div class="group flex items-center justify-between gap-2 p-2 rounded-lg border-glow border-0 backdrop-blur-[10px] relative overflow-hidden shadow-sm hover:-translate-y-1 transition-all duration-300 cursor-pointer"
                                         style="background: ${cardGradient};">
                                    
                                    <!-- Saetta Gold (Animated Shimmer) -->
                                    <div class="saetta-gold"></div>
                                    
                                    <!-- Glass Shine Effect -->
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-lg pointer-events-none z-0"></div>

                                    <div class="flex items-center gap-2 min-w-0 flex-1 relative z-10">
                                        <span class="material-symbols-outlined text-white text-[18px] shrink-0">${icon}</span>
                                        <div class="flex flex-col min-w-0">
                                            <span class="text-white text-[11px] font-bold leading-tight truncate uppercase tracking-tight drop-shadow-sm">${title}</span>
                                            <span class="text-white/70 text-[9px] truncate">${deadline.name || ''} ${deadline.veicolo_modello ? '• ' + deadline.veicolo_modello : ''}</span>
                                        </div>
                                    </div>
                                    <div class="px-2 py-0.5 rounded-full ${badgeColor} text-white text-[10px] font-bold shrink-0 shadow-sm relative z-10">
                                        ${badgeText}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (e) {
                console.error("Error loading urgent deadlines:", e);
            }
        }

        // Load expired deadlines and render list
        async function loadExpiredDeadlines(user) {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const snap = await getDocs(collection(db, "users", user.uid, "scadenze"));

                const expiredDeadlines = [];

                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const isCompleted = data.completed === true || data.status === 'completed';
                    if (isCompleted) return; // Salta se completato
                    if (data.dueDate) {
                        const dueDate = new Date(data.dueDate);
                        dueDate.setHours(0, 0, 0, 0);

                        // Check if deadline has passed
                        if (dueDate < today) {
                            expiredDeadlines.push({
                                id: docSnap.id,
                                ...data,
                                dueDate: dueDate
                            });
                        }
                    }
                });

                // Sort by due date (most recent first)
                expiredDeadlines.sort((a, b) => b.dueDate - a.dueDate);

                // Render expired deadline cards in URGENZE section
                const urgenzeList = document.getElementById('urgenze-list');
                if (urgenzeList) {
                    if (expiredDeadlines.length === 0) {
                        urgenzeList.innerHTML = `
                            <div class="flex items-center justify-center p-4">
                                <p class="text-gray-400 text-xs italic text-center">Nessuna scadenza scaduta</p>
                            </div>
                        `;
                    } else {
                        urgenzeList.innerHTML = expiredDeadlines.map(deadline => {
                            const daysUntil = Math.ceil((deadline.dueDate - today) / (1000 * 60 * 60 * 24));
                            const daysAgo = Math.abs(daysUntil);
                            let badgeText = `${daysAgo}g fa`;

                            if (daysAgo === 0) {
                                badgeText = 'Oggi';
                            } else if (daysAgo === 1) {
                                badgeText = 'Ieri';
                            }

                            const icon = deadline.icon || 'event';
                            const title = deadline.title || 'Scadenza';

                            // Dynamic card color for Urgenze (usually all red as they are expired, but we keep the logic)
                            let cardGradient = 'linear-gradient(135deg, #6d1a1a 0%, #1a0505 100%)';
                            if (daysUntil >= 0) {
                                cardGradient = 'linear-gradient(135deg, #f59e0b 0%, #92400e 100%)';
                            }

                            return `
                                <a href="scadenze.html" class="block mb-2 group hover:-translate-y-1 transition-all duration-300">
                                     <div class="flex items-center justify-between gap-3 p-3 rounded-xl border-glow border-0 active:scale-[0.98] transition-all cursor-pointer backdrop-blur-[14px] group overflow-hidden relative shadow-lg" 
                                          style="background: ${cardGradient};">
                                        
                                        <!-- Saetta Gold (Animated Shimmer) -->
                                        <div class="saetta-gold"></div>
                                        
                                        <!-- Glass Shine Effect -->
                                        <div class="absolute inset-0 bg-gradient-to-br from-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-xl pointer-events-none z-0"></div>

                                        <div class="flex items-center gap-3 min-w-0 flex-1 relative z-10">
                                            <div class="size-8 rounded-lg bg-white/10 flex items-center justify-center text-white shrink-0 border border-white/20">
                                                <span class="material-symbols-outlined text-[20px] filled">${icon}</span>
                                            </div>
                                            <div class="min-w-0 flex-1 flex flex-col gap-0.5">
                                                <p class="text-white text-[13px] font-bold leading-tight truncate uppercase tracking-tight drop-shadow-sm">${title}</p>
                                                <p class="text-white/60 text-[11px] truncate flex items-center gap-1">
                                                    <span class="font-medium text-red-200">${deadline.name || 'Generale'}</span> 
                                                    ${deadline.veicolo_modello ? '• ' + deadline.veicolo_modello : ''} • ${badgeText}
                                                </p>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end gap-1 relative z-10">
                                            <div class="px-2 py-0.5 rounded-full bg-red-600 text-white border border-red-500 text-[9px] font-bold shrink-0 shadow-[0_0_10px_rgba(239,68,68,0.4)]">
                                                URGENTE
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            `;
                        }).join('');
                    }
                }
            } catch (e) {
                console.error("Error loading expired deadlines:", e);
            }
        }

        // --- NOTIFICATIONS SYSTEM ---
        async function checkNotifications(uid) {
            try {
                const q = query(collection(db, "users", uid, "notifications"), where("read", "==", false));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    // Show the first one for now
                    const docSnap = snap.docs[0];
                    const note = docSnap.data();
                    showNotificationBanner(docSnap.id, note);
                }
            } catch (e) { console.error("Notif check error", e); }
        }

        function showNotificationBanner(id, note) {
            const banner = document.getElementById('notification-banner');
            if (!banner) return;

            banner.classList.remove('hidden');
            banner.className = "fixed top-4 right-4 p-4 rounded-xl text-white z-[9999] bg-orange-600/90 backdrop-blur shadow-2xl max-w-xs animate-in slide-in-from-top-4 duration-500 border border-orange-400/50";
            banner.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="bg-white/20 p-2 rounded-full shrink-0">
                        <span class="material-symbols-outlined text-xl">notifications_active</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-sm leading-tight mb-1">Notifica Condivisione</p>
                        <p class="text-xs opacity-90 mb-3 leading-snug">${note.message || 'Aggiornamento account condiviso.'}</p>
                        <button onclick="window.handleNotification('${id}')" 
                                class="bg-white text-orange-700 px-4 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-orange-50 transition-colors w-full">
                            Ho capito
                        </button>
                    </div>
                </div>
            `;
        }

        window.handleNotification = async (notifId) => {
            const banner = document.getElementById('notification-banner');
            if (banner) banner.classList.add('hidden');

            try {
                await deleteDoc(doc(db, "users", auth.currentUser.uid, "notifications", notifId));
                // Check for more?
                checkNotifications(auth.currentUser.uid);
            } catch (e) { console.error("Error clearing notif", e); }
        };

        // --- RULE 4: Handle Invite Accept/Reject ---
        window.handleInvite = async (inviteId, accepted, guestUid) => {
            try {
                // 1. Get invite data first
                const inviteRef = doc(db, "invites", inviteId);
                const inviteSnap = await getDoc(inviteRef);
                if (!inviteSnap.exists()) {
                    alert("Invito non trovato.");
                    return;
                }
                const inviteData = inviteSnap.data();
                const ownerId = inviteData.ownerId;
                const accountId = inviteData.accountId;
                const aziendaId = inviteData.aziendaId; // May be null for private
                const recipientEmail = inviteData.recipientEmail;

                // 2. Build account document reference
                let accountRef;
                if (aziendaId) {
                    // Company Account
                    accountRef = doc(db, "users", ownerId, "aziende", aziendaId, "accounts", accountId);
                } else {
                    // Private Account
                    accountRef = doc(db, "users", ownerId, "accounts", accountId);
                }

                // 3. Read current sharedWith array
                const accountSnap = await getDoc(accountRef);
                if (!accountSnap.exists()) {
                    console.error("Account non trovato per aggiornamento sharedWith.");
                    // Still delete invite if gone
                    await deleteDoc(inviteRef);
                    checkInvitations(auth.currentUser.email, auth.currentUser.uid);
                    return;
                }
                let sharedWith = accountSnap.data().sharedWith || [];

                // 4. Process sharedWith based on action
                let updatedSharedWith;
                if (accepted) {
                    // ACCEPT: Update status to 'accepted'
                    updatedSharedWith = sharedWith.map(item => {
                        if (typeof item === 'object' && item.email === recipientEmail) {
                            return { ...item, status: 'accepted' };
                        }
                        return item;
                    });
                } else {
                    // REJECT: Remove the entry entirely
                    updatedSharedWith = sharedWith.filter(item => {
                        if (typeof item === 'object') {
                            return item.email !== recipientEmail;
                        }
                        return true; // Keep legacy UIDs
                    });
                }

                // 5. Check if we need to auto-unshare (no accepted users left)
                const hasActiveShares = updatedSharedWith.some(item => {
                    if (typeof item === 'string') return true; // Legacy UID = active
                    if (typeof item === 'object' && item.status === 'accepted') return true;
                    if (typeof item === 'object' && item.status === 'pending') return true;
                    return false;
                });

                // 6. Write back updated sharedWith and potentially unshare
                const updatePayload = { sharedWith: updatedSharedWith };
                if (!hasActiveShares) {
                    updatePayload.shared = false; // Auto-unshare
                }
                await updateDoc(accountRef, updatePayload);

                // 7. Update Invite status or delete
                if (accepted) {
                    await updateDoc(inviteRef, { status: 'accepted' });
                } else {
                    // Delete invite so it doesn't show up for invitee
                    await deleteDoc(inviteRef);
                }

                // 8. Notify Owner
                const notifMessage = accepted
                    ? `L'utente ${recipientEmail} ha accettato il tuo invito!`
                    : `L'utente ${recipientEmail} ha rifiutato il tuo invito.`;

                await addDoc(collection(db, "users", ownerId, "notifications"), {
                    type: accepted ? "invite_accepted" : "invite_rejected",
                    message: notifMessage,
                    timestamp: new Date(),
                    read: false,
                    accountId: accountId,
                    relatedEmail: recipientEmail
                });

                // 9. Refresh UI
                alert(accepted ? "Invito accettato!" : "Invito rifiutato.");
                checkInvitations(auth.currentUser.email, auth.currentUser.uid);
                if (accepted) {
                    checkSharedAccounts(auth.currentUser.email);
                }
            } catch (e) {
                console.error("Errore gestione invito:", e);
                alert("Errore: " + e.message);
            }
        };
    </script>

    <!-- Bottom Quick Actions Bar (Sfumato) -->
    <div
        class="fixed bottom-0 left-0 right-0 w-full md:max-w-3xl lg:max-w-5xl mx-auto bg-gradient-to-t from-[#0a0f1e] to-transparent backdrop-blur-md z-50">
        <div class="flex items-center justify-around px-4 py-3 w-full md:max-w-3xl lg:max-w-5xl mx-auto">
            <!-- Sicurezza Vault Badge -->
            <div class="flex flex-col items-center gap-1 p-2">
                <div class="flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-primary text-[20px]">shield</span>
                    <span class="text-white text-lg font-bold">98%</span>
                </div>
                <span class="text-[10px] text-gray-500  font-medium">Sicurezza</span>
            </div>

            <!-- Settings Button -->
            <!-- Settings Button -->
            <a href="impostazioni.html"
                class="flex flex-col items-center gap-1 p-2 rounded-lg transition-transform hover:scale-105 active:scale-95 group">
                <span
                    class="material-symbols-outlined text-white group-hover:text-primary transition-colors text-[28px]">settings</span>
                <span
                    class="text-xs text-white group-hover:text-primary transition-colors font-medium">Impostazioni</span>
            </a>

            <!-- Placeholder for future shortcuts -->
            <!-- Add more quick action buttons here as needed -->
        </div>
    </div>
</body>

</html>