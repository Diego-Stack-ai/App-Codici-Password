rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuth() { return request.auth != null; }

    // --- 1. UTENTI & PROPRIETARIO (ACCESSO TOTALE) ---
    match /users/{userId}/{allPaths=**} {
      allow read, write: if isAuth() && request.auth.uid == userId;
    }

    // --- 2. ACCESSO OSPITI (SHARED DATA) ---
    // Regole ultra-permissive per quando un account Ã¨ segnato come condiviso.
    // Supportiamo sia il nuovo flag 'visibility: shared' che il vecchio 'shared: true' o 'isMemoShared: true'.
    match /users/{userId}/accounts/{accountId} {
      allow read, update: if isAuth() && (
        resource.data.get('visibility', 'private') == 'shared' || 
        resource.data.get('shared', false) == true ||
        resource.data.get('isMemoShared', false) == true
      );
    }
    match /users/{userId}/aziende/{aziendaId}/accounts/{accountId} {
      allow read, update: if isAuth() && (
        resource.data.get('visibility', 'private') == 'shared' || 
        resource.data.get('shared', false) == true ||
        resource.data.get('isMemoShared', false) == true
      );
    }

    // Notifiche (Permetti invio da terzi per risposte condivisione)
    match /users/{userId}/notifications/{notifId} {
      allow create: if isAuth(); 
    }

    // --- 3. INVITI (INVITES) ---
    match /invites/{inviteId} {
      allow list, create: if isAuth(); 
      allow read, update, delete: if isAuth() && (
        resource == null ||
        resource.data.get('ownerId', '') == request.auth.uid || 
        resource.data.get('senderId', '') == request.auth.uid ||
        resource.data.get('recipientEmail', '').lower() == (request.auth.token.email || "").lower() ||
        resource.data.get('recipientEmail', '') == request.auth.token.email
      );
    }
  }
}
